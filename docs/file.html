<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Decrypt Secure File</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .success { color: #10b981; font-weight: 600; } /* Emerald-500 */
        .error { color: #ef4444; font-weight: 600; } /* Red-500 */
        /* Style for the pre-formatted text content display */
        #decryptedTextContent { 
            white-space: pre-wrap; 
            word-wrap: break-word; 
            background-color: #f3f4f6; /* gray-100 */
            border: 1px solid #e5e7eb; /* gray-200 */
            padding: 16px;
            border-radius: 8px;
            font-family: monospace;
            margin-top: 16px;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-lg">
        <h1 class="text-3xl font-bold text-gray-800 mb-4 text-center">ðŸ”’ Decrypt Secured Content</h1>
        <p id="filenameDisplay" class="text-gray-600 mb-4 text-center">Fetching file details...</p>

        <div id="expirationDisplay" class="text-sm text-center text-red-500 mb-4 font-medium"></div>

        <div class="space-y-4">
            <input type="password" id="passphrase" placeholder="Enter Secret Passphrase" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
            
            <button onclick="decryptFile()" class="w-full py-3 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 transition duration-150">
                Decrypt & Download
            </button>
            
            <div id="statusMessage" class="p-4 bg-gray-50 border border-gray-200 rounded-lg text-gray-700">Ready to decrypt.</div>

            <div id="decryptedTextContent" class="hidden"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    
    <script>
      // Replace values with your actual Firebase keys
      const firebaseConfig = {
        apiKey: "AIzaSyBMcG...", 
        authDomain: "securing-app.firebaseapp.com",
        projectId: "securing-app",
        storageBucket: "securing-app.firebasestorage.app",
        messagingSenderId: "1005545403992",
        appId: "1:1005545403992:web:eb524658db38b2df7b7c2d",
        measurementId: "G-H8MVQKP75K"
      };

      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      const storage = firebase.storage();

      // Decryption Logic
      async function decryptFile() {
        const passphrase = document.getElementById('passphrase').value;
        const statusDiv = document.getElementById('statusMessage');
        const contentDiv = document.getElementById('decryptedTextContent');
        statusDiv.innerHTML = 'Attempting decryption...';
        contentDiv.textContent = ''; 
        contentDiv.classList.add('hidden');

        if (!passphrase) {
            statusDiv.innerHTML = '<span class="error">Please enter the passphrase.</span>';
            return;
        }
        
        const urlParams = new URLSearchParams(window.location.search);
        const fileId = urlParams.get('id');

        if (!fileId) {
            statusDiv.innerHTML = '<span class="error">Error: File ID not found in the URL.</span>';
            return;
        }

        try {
            // 1. Fetch the metadata from Firestore
            const docRef = db.collection('encryptedFiles').doc(fileId);
            const doc = await docRef.get();

            if (!doc.exists) {
                statusDiv.innerHTML = '<span class="error">File not found or has been deleted.</span>';
                return;
            }

            const data = doc.data();
            const mode = data.mode || 'file'; // Default to 'file' if mode not present
            let ciphertext;
            
            // Check for expiration
            if (data.expirationTimestamp && data.expirationTimestamp < Date.now()) {
                statusDiv.innerHTML = '<span class="error">This file has expired and is no longer available.</span>';
                return;
            }

            // 2. Fetch the ciphertext based on mode
            if (mode === 'file') {
                statusDiv.innerHTML = 'Fetching encrypted file from cloud storage...';
                const response = await fetch(data.storageUrl);
                ciphertext = await response.text();
            } else { // mode === 'text'
                statusDiv.innerHTML = 'Fetching encrypted message from database...';
                ciphertext = data.ciphertext;
                if (!ciphertext) {
                    throw new Error("Ciphertext missing for text mode.");
                }
            }
            
            // 3. Decrypt the ciphertext
            const bytes  = CryptoJS.AES.decrypt(ciphertext, passphrase);
            const plaintext = bytes.toString(CryptoJS.enc.Utf8);
            
            if (plaintext === '' || plaintext.length < 5) { 
                // Check for failed decryption (e.g., incorrect key)
                statusDiv.innerHTML = '<span class="error">Decryption failed. Incorrect passphrase or corrupted data.</span>';
                return;
            }
            
            // 4. Handle output based on mode
            if (mode === 'file') {
                // Trigger Automatic Download (NO LONGER SHOWS RAW CONTENT)
                statusDiv.innerHTML = `<span class="success">Decryption successful! The file has been downloaded automatically.</span>`;
                
                const blob = new Blob([plaintext], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = data.filename || `decrypted_file_${fileId}.txt`;
                a.click();
                URL.revokeObjectURL(url);
            } else { // mode === 'text'
                // Display the decrypted text content
                statusDiv.innerHTML = `<span class="success">Decryption successful! The message is displayed below.</span>`;
                contentDiv.textContent = plaintext;
                contentDiv.classList.remove('hidden');
            }
            
        } catch (e) {
            console.error("Decryption Error:", e);
            statusDiv.innerHTML = `<span class="error">An internal error occurred during decryption. Check browser console for errors.</span>`;
        }
      }

      // Initial check on page load to display filename and expiration
      document.addEventListener('DOMContentLoaded', async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const fileId = urlParams.get('id');
        const expirationDisplay = document.getElementById('expirationDisplay');

        if (fileId) {
            try {
                const doc = await db.collection('encryptedFiles').doc(fileId).get();
                if (doc.exists) {
                    const data = doc.data();
                    document.getElementById('filenameDisplay').textContent = `File/Message Name: ${data.filename || 'Unnamed Content'}`;
                    
                    // Display expiration status
                    if (data.expirationTimestamp) {
                        const now = Date.now();
                        const expiresAt = data.expirationTimestamp;
                        if (expiresAt < now) {
                            expirationDisplay.textContent = 'Status: EXPIRED and should be deleted.';
                        } else {
                            const remaining = expiresAt - now;
                            const remainingHours = Math.ceil(remaining / (1000 * 60 * 60));
                            expirationDisplay.textContent = `Status: Expires in approximately ${remainingHours} hours.`;
                            expirationDisplay.classList.remove('text-red-500');
                            expirationDisplay.classList.add('text-green-600');
                        }
                    } else {
                        expirationDisplay.textContent = 'Status: Does not expire (Manual deletion required).';
                        expirationDisplay.classList.remove('text-red-500');
                        expirationDisplay.classList.add('text-gray-500');
                    }
                } else {
                    document.getElementById('filenameDisplay').textContent = 'Content Not Found.';
                }
            } catch (e) {
                document.getElementById('filenameDisplay').textContent = 'Error Fetching Details.';
            }
        } else {
            document.getElementById('filenameDisplay').textContent = 'Content ID Missing.';
        }
      });
    </script>
</body>
</html>
